<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="../bower_components/esprima/esprima.js"></script>
    <script src="../bower_components/escodegen/escodegen.browser.js"></script>
    <script src="../external/ast-walker/src/walker.js"></script>
    <script src="../src/ast-builder.js"></script>
    <script src="../src/stack.js"></script>
    <script src="../src/injector.js"></script>
    <script src="../src/stepper.js"></script>
</head>
<body>

</body>
</html>
<script>

    function Stepper2 (context) {
        this.context = context;

        this.yieldVal = undefined;
    }

    Stepper2.prototype.generateDebugCode = function (code) {
        this.ast = esprima.parse(code, { loc: true });

        injector.process(this.ast, this.context);

        return "return function*(){\nwith(arguments[0]){\n"
                + escodegen.generate(this.ast) + "\n}\n}";
    };

    Stepper2.prototype.load = function (code) {
        this.debugCode = this.generateDebugCode(code);
        this.reset();
    };

    Stepper2.prototype.reset = function () {
        this.stack = new Stack();
        
        this.stack.push({
            gen: ((new Function(this.debugCode))())(this.context),
            lineno: 0
        });
    };
    
    Stepper2.prototype.step = function () {
        if (this.stack.isEmpty()) {
            return;
        }
        var frame = this.stack.peek();
        var result = frame.gen.next(this.yieldVal);
        this.yieldVal = undefined;
        return result;
    };
    
    Stepper2.prototype.stepIn = function () {
        var result = this.step();
        if (result.done) {
            var frame = this.stack.pop();
            this.yieldVal = result.value;
            return frame.lineno;
        } else if (result.value.gen) {
            this.stack.push(result.value);
        }
        return result.value && result.value.lineno;
    };
    
    Stepper2.prototype.stepOver = function () {
        var result = this.step();
        if (result.done) {
            var frame = this.stack.pop();
            this.yieldVal = result.value;
            return frame.lineno;
        } else if (result.value.gen) {
            this.stack.push(result.value);
            this.yieldVal = this.runScope();
            this.stack.pop();
        }
        return result.value && result.value.lineno;
    };
    
    Stepper2.prototype.stepOut = function () {
        var result = this.step();
        while (!result.done) {
            if (result.value.gen) {
                this.stack.push(result.value);
                this.yieldVal = this.runScope();
                this.stack.pop();
            }
            result = this.step();
        }
        var frame = this.stack.pop();
        this.yieldVal = result.value;
        return frame.lineno;
    };
    
    Stepper2.prototype.run = function () {
        while (!this.stack.isEmpty()) {
            var lineno = this.stepIn();
            if (lineno) {
                console.log("lineno: " + lineno);
            } else {
                console.log("no lineno");
            }
        }
    };
    
    Stepper2.prototype.runScope = function () {
        var result = this.step();
        while (!result.done) {
            if (result.value.gen) {
                this.stack.push(result.value);
                this.yieldVal = this.runScope();
                this.stack.pop();
            }
            result = this.step();
        }
        return result.value;
    };

    var context = {
        print: console.log.bind(console)
    };

    var stepper = new Stepper(context);
    var code = "var add = function(x,y) {\n" +
            "  return x + y;\n" +
            "};\n" +
            "\n" +
            "print(add(add(1,2),add(3,4)));\n" +
            "print('hello, world');";

    stepper.load(code);
    console.log(stepper.debugCode);
    
    console.log("----- run -----");
    stepper.run();

    console.log("----- runScope -----");
    stepper.reset();
    stepper.runScope();

    console.log("----- stepOver -----");
    stepper.reset();
    while (true) {
        var lineno = stepper.stepOver();
        if (lineno) {
            console.log("lineno: " + lineno);
        } else {
            break;
        }
    }
    
</script>